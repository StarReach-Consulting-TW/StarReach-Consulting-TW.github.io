<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é–‹ç¥¨å°å·¥å…· (v4 - æ•´åˆç‰ˆ)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        .container {
            background-color: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1a0dab;
            text-align: center;
            margin-bottom: 30px;
        }
        /* Tab æ¨£å¼ */
        .tab-container {
            display: flex;
            border-bottom: 2px solid #ccc;
            margin-bottom: 20px;
            overflow-x: auto; /* ç¢ºä¿åœ¨æ‰‹æ©Ÿä¸Šå¯ä»¥æ»‘å‹• */
        }
        .tab-link {
            padding: 10px 20px;
            cursor: pointer;
            border: 2px solid transparent;
            border-bottom: none;
            background-color: #c9c9c9;
            font-size: 16px; /* ç¨å¾®ç¸®å°å­—é«”ä»¥å®¹ç´æ›´å¤šæ¨™ç±¤ */
            white-space: nowrap; /* é˜²æ­¢æ›è¡Œ */
            border-radius: 8px 8px 0 0;
            margin-right: 5px;
            position: relative;
            top: 0;
        }
        .tab-link.active {
            background-color: #4b4b4b;
            color: white;
            border-color: #4b4b4b #4b4b4b #fff #4b4b4b;
            z-index: 1;
        }
        /* é€šç”¨å…§å®¹æ¨£å¼ */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        button {
            padding: 8px 12px;
            font-size: 14px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover { background-color: #357ae8; }
        .input-container {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        .main-action-btn-label {
            flex: 1;
            display: block;
            padding: 12px;
            font-size: 18px;
            background-color: #4285f4;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-align: center;
        }
        .main-action-btn-label:hover { background-color: #357ae8; }
        #clear-btn-xml {
            background-color: #dc3545;
            margin: 0 auto 15px auto;
            display: none;
        }
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #eee;
            padding-bottom: 15px;
            margin-top: 30px;
        }
        h2 { margin: 0; padding: 0; border: none; }
        pre {
            background-color: #eef;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: "Courier New", Courier, monospace;
            border: 1px solid #ddd;
            max-height: 400px;
            overflow-y: auto;
        }
        .warning, .status, .download-area {
            padding: 10px 15px;
            border-radius: 5px;
            margin: 15px 0;
            text-align: center;
        }
        .warning {
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            color: #ad8600;
        }
        .status {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            font-style: italic;
            word-break: break-all;
        }
        .download-area {
            background-color: #e6f4ea;
            border: 1px solid #b7e1c1;
            display: none;
            flex-direction: column;
            gap: 10px;
        }
        .download-area a {
            color: #155724;
            font-weight: bold;
            text-decoration: none;
            font-size: 18px;
        }
        .download-area a:hover { text-decoration: underline; }
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 20px 0;
            border: 2px dashed #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .action-label {
            display: block; 
            width: 100%; 
            padding: 12px; 
            font-size: 18px; 
            background-color: #4285f4; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            transition: background-color 0.3s; 
            text-align: center; 
            box-sizing: border-box; 
            margin: 20px 0;
        }
        .action-label:hover { background-color: #357ae8; }
        .options-group { margin-bottom: 15px; }
        .options-group label { margin-right: 15px; }
        .options-group p { margin-top: 0; margin-bottom: 5px; font-weight: bold; }

        /* æ–°å¢çš„æ¨£å¼: ä¸‹è¼‰é€£çµæ–¹æ ¼ */
        .download-links-container {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap; 
            margin-top: 20px;
        }

        .download-link-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            background-color: #4285f4;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .download-link-box:hover {
            background-color: #357ae8;
            transform: translateY(-2px);
        }

        /* ç°¡å–®çš„ä¸‹è¼‰åœ–æ¨™ */
        .download-link-box::before {
            content: 'â†“';
            font-size: 20px;
        }

        /* === å·¥å…·ä¸€ (æ¯”å°) çš„å°ˆå±¬æ¨£å¼ === */
        #drop-zone {
            border: 3px dashed #ccc;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            height: 200px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            color: #aaa;
            transition: background-color 0.3s, border-color 0.3s;
        }
        #drop-zone.dragover {
            background-color: #e0f0ff;
            border-color: #007bff;
        }
        #results-container-compare {
            margin: 20px auto;
            width: 100%;
        }
        /* ğŸŒŸ ä¿®æ”¹: ç§»é™¤ float: right å’Œ margin-bottom */
        #copy-btn-compare {
            display: none; 
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        #copy-btn-compare:hover {
            background-color: #0056b3;
        }
		/* ğŸŒŸ ä¿®æ”¹: ç§»é™¤ float: right å’Œ margin-bottom/margin-right */
		#download-xlsx-btn-compare {
			display: none; 
			background-color: #28a745; 
			color: white;
			padding: 10px 15px;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 1em;
		}
		#download-xlsx-btn-compare:hover {
			background-color: #1e7e34; /* æ‡¸åœæ™‚é¡è‰²è®Šæ·± */
		}
		/* ğŸŒŸ æ–°å¢/èª¿æ•´: é ‚éƒ¨æ§åˆ¶åˆ—çš„ Flex å®¹å™¨ */
        #top-controls-row {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            flex-wrap: wrap; /* å…è¨±æ›è¡Œä»¥é©æ‡‰å°è¢å¹• */
        }

        /* ğŸŒŸ æ–°å¢/èª¿æ•´: ç¯©é¸å€å¡Šçš„æ¨£å¼ (åŸå…§åµŒæ¨£å¼) */
        #filter-controls-compare { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            border: 1px solid #ddd; 
            padding: 10px; 
            border-radius: 5px; 
            flex-grow: 1; 
            min-width: 300px; 
            max-width: 50%; /* ä½”ç”¨æœ€å¤š 70% å¯¬åº¦ï¼Œè®“å³å´æŒ‰éˆ•æœ‰ç©ºé–“ */
            margin-right: 10px;
        }
        
        /* ğŸŒŸ æ–°å¢: ç¯©é¸å€å¡Šä¸­ Label çš„æ¨£å¼ */
        #filter-controls-compare label[for="hescode-filter"] {
            white-space: nowrap; /* é˜²æ­¢æ¨™ç±¤æ›è¡Œ */
        }
        
        /* ğŸŒŸ æ–°å¢: Hescode Select æ¡†çš„æ¨£å¼ */
        #hescode-filter { 
            padding: 5px; 
            border-radius: 3px; 
            font-size: 14px; 
            flex-grow: 1; 
            min-width: 100px;
        }
        
        /* ğŸŒŸ æ–°å¢: ç¯©é¸è¨ˆæ•¸çš„æ¨£å¼ */
        #filtered-count {
            font-weight: bold; 
            color: #007bff; 
            white-space: nowrap;
        }

        /* ğŸŒŸ æ–°å¢/èª¿æ•´: æŒ‰éˆ•å€å¡Šçš„æ¨£å¼ */
        #action-buttons-compare {
            display: flex; 
            gap: 10px; 
            flex-shrink: 0; 
            margin-top: 5px;
        }
		
        #result-table-compare {
            width: 100%;
            border-collapse: collapse;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            clear: both; 
        }
        #result-table-compare th, #result-table-compare td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        #result-table-compare th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }
        #result-body-compare tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        #result-body-compare tr:hover {
            background-color: #f1f1f1;
        }
		
		#drop-area-xml {
		  border: 2px dashed #ccc;
		  border-radius: 8px;
		  padding: 20px;
		  margin: 20px 0;
		  text-align: center;
		  font-family: sans-serif;
		  color: #333;
		  transition: border-color 0.2s, background-color 0.2s;
		  display: flex;
		  flex-direction: column;
		  align-items: center;
		}

		/* æª”æ¡ˆæ‹–æ›³é€²å…¥æ™‚çš„è¦–è¦ºå›é¥‹æ¨£å¼ */
		#drop-area-xml.highlight {
		  border-color: #007bff; /* è—è‰²é‚Šæ¡† */
		  background-color: #e6f7ff; /* æ·ºè—è‰²èƒŒæ™¯ */
		}

		/* ç¢ºä¿æ‚¨çš„æŒ‰éˆ•æ¨£å¼ (å¦‚æœæ‚¨ä½¿ç”¨ label æ¨¡æ“¬æŒ‰éˆ•çš„è©±) */
		.button {
			display: inline-block;
			background-color: #007bff;
			color: white;
			padding: 10px 15px;
			border-radius: 5px;
			cursor: pointer;
			margin: 5px;
		}
        /* ğŸŒŸ æ–°å¢: è‡ªè¨‚è¨Šæ¯æç¤ºæ¡† (Custom Alert) æ¨£å¼ */
        #custom-alert {
            visibility: hidden; /* é è¨­éš±è— */
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            text-align: center;
            border-radius: 6px;
            padding: 16px;
			font-weight: bold;
            position: fixed;
            z-index: 9999; /* ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
            right: 20px;
            top: 50px;
            font-size: 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: visibility 0s, opacity 0.5s linear;
        }

        #custom-alert.show {
            visibility: visible;
            opacity: 1;
        }

        /* æˆåŠŸè¨Šæ¯çš„æ¨£å¼ */
        #custom-alert.success {
            background-color: #beedc0; /* ç¶ è‰² */
			border: 2px solid #fff;
			color: #08730c;
        }

        /* éŒ¯èª¤è¨Šæ¯çš„æ¨£å¼ */
        #custom-alert.error {
            background-color: #f5beba; /* ç¶ è‰² */
			border: 2px solid #fff;
			color: #910b01;
        }
		
    </style>

    <script src="jszip.min.js"></script>
    <script src="papaparse.min.js"></script>
    <script src="xlsx.full.min.js"></script>

</head>
<body>
    <div class="container">
        <h1>é–‹ç¥¨å°å·¥å…·</h1>

        <div class="tab-container">
            <button class="tab-link active" data-tab="tool-compare">CSV/XML è¡¨è™Ÿæ¯”å°</button> 
            <button class="tab-link" data-tab="tool-xml">XML è¡¨è™Ÿè§£æ</button>
            <button class="tab-link" data-tab="tool-zip">ZIP ä¸­ç¹¼æª”è§£æ</button>
            <button class="tab-link" data-tab="tool-merge-split">ä¾‹å¤–æ¸…å–®è™•ç†</button>
        </div>

        <div class="content-container">

            <div id="tool-compare" class="tab-content active">
                <div class="warning">
                    <strong>åŠŸèƒ½ï¼š</strong> æ¯”å° CSV å…§ Meter ID æ˜¯å¦å­˜åœ¨æ–¼ XML æª”æ¡ˆä¸­ã€‚
                </div>
                <p style="text-align:center;">è«‹<strong>åŒæ™‚</strong>å°‡ä¸€å€‹ CSV æª” å’Œä¸€å€‹ ZIP æª”æ¡ˆæ‹–æ›³åˆ°ä¸‹æ–¹å€åŸŸ</p>

                <div id="drop-zone">å°‡ .csv æª”å’Œ .zip æª”æ‹–æ›³åˆ°é€™è£¡</div>
                
                <div id="status-compare" class="status">æ­£åœ¨ç­‰å¾…æª”æ¡ˆæ‹–æ›³...</div> 

                <h3>æ¯”è¼ƒçµæœ (CSV ä¸­å­˜åœ¨ï¼Œä½† ZIP ä¸­æ‰¾ä¸åˆ° Meter ID)</h3>
				
                <div id="top-controls-row"> 
                    
                    <div id="filter-controls-compare">
                        <label for="hescode-filter">ä¾ Hescode ç¯©é¸:</label>
                        <select id="hescode-filter">
                            <option value="all">æ‰€æœ‰ Hescode</option>
                        </select>
                        <span id="filtered-count"></span>
                    </div>

                    <div id="action-buttons-compare">
                        <button id="copy-btn-compare">ä¸€éµè¤‡è£½</button>
                        <button id="download-xlsx-btn-compare">ä¸‹è¼‰ XLSX (ALL)</button>
                    </div>

                </div>
                <div id="results-container-compare">
                    <table id="result-table-compare">
                        <thead>
                            <tr>
                                <th>cust_id</th>
                                <th>meter_id</th>
                                <th>Hescode</th>
                                <th>éœ€é‡(T/F)</th>
                            </tr>
                        </thead>
                        <tbody id="result-body-compare">
                            <tr><td colspan="4" style="text-align:center;">çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <div id="tool-xml" class="tab-content">
                <div class="warning">
                    <strong>åŠŸèƒ½ï¼š</strong> å¿«é€Ÿæ“·å–è³‡æ–™å¤¾æˆ– ZIP æª”å…§æ‰€æœ‰ XML çš„è¡¨è™Ÿã€‚
                </div>
                <p>è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•é¸æ“‡**ä¸€å€‹æˆ–å¤šå€‹è³‡æ–™å¤¾**ï¼Œæˆ–**ä¸€å€‹æˆ–å¤šå€‹ .zip å£“ç¸®æª”**é€²è¡Œåˆ†æã€‚çµæœæœƒç´¯åŠ é¡¯ç¤ºæ–¼é è¦½å€ï¼Œä¸¦å¯ä¸‹è¼‰åˆä½µå¾Œçš„ CSV æª”æ¡ˆã€‚</p>

				<div id="drop-area-xml">
				  <p>æˆ–å°‡ .xml æª”æ¡ˆæˆ– .zip å£“ç¸®æª”æ‹–æ›³è‡³æ­¤å€åŸŸä¸Šå‚³</p>
				  
				  <label for="folder-input-xml" class="button">é¸æ“‡è³‡æ–™å¤¾</label>
				  <input type="file" id="folder-input-xml" webkitdirectory directory multiple style="display: none;">
				  
				  <label for="zip-input-xml" class="button">é¸æ“‡å£“ç¸®æª” (.zip)</label>
				  <input type="file" id="zip-input-xml" multiple accept=".zip" style="display: none;">
				</div>
                <button id="clear-btn-xml">æ¸…é™¤çµæœä¸¦é‡æ–°é–‹å§‹</button>
                <div class="results-header">
                    <h2>è¡¨è™Ÿé è¦½ï¼š</h2>
                    <button id="copy-btn-xml" style="display: none;">è¤‡è£½çµæœ</button>
                </div>
				<div id="status-xml">ç­‰å¾…è™•ç†...</div>
				<pre id="results-display-xml">...</pre>
				<div id="download-area-xml"></div>      
			</div>
			
            <div id="tool-zip" class="tab-content">
                <div class="warning">
                    <strong>åŠŸèƒ½ï¼š</strong> å¿«é€Ÿæ•´ç†ä¸­ç¹¼æª”( MDMSL_YYYMMNN.zip )è³‡æ–™å¤¾å…§æ‰€æœ‰é›»è™Ÿè¡¨è™ŸåŠè¡¨åˆ¥ã€‚
                </div>			
                <p>è«‹ä¸Šå‚³ä¸€å€‹ .zip å£“ç¸®æª”ã€‚æ­¤å·¥å…·å°‡æœƒå° .txt æª”æ¡ˆå…§å®¹é€²è¡Œåˆ†çµ„èˆ‡å½™ç¸½ï¼Œæœ€çµ‚ç”Ÿæˆä¸€å€‹åŒ…å«ã€Œé›»è™Ÿã€ã€ã€Œè¡¨è™Ÿã€èˆ‡ã€Œè¡¨åˆ¥ã€çš„ Excel (.xlsx) æª”æ¡ˆä¸‹è¼‰é€£çµã€‚</p>
        
                <input type="file" id="zipFile-zip" accept=".zip">
                
                <div id="status-zip" class="status"></div>
                <div id="download-area-zip" class="download-area"></div>
            </div>

            <div id="tool-merge-split" class="tab-content">
                <div class="warning">
                    <strong>åŠŸèƒ½ï¼š</strong> ä¸€æ¬¡æ€§å°‡å¤šå€‹ä¾‹å¤–æ¸…å–®åˆä½µä¸¦æ•´ç†ç‚º CSVï¼ŒåŒæ™‚å°‡åˆä½µçµæœæ ¹æ“šå€è™•æ‹†åˆ†ã€‚
                </div>
                <p>è«‹é¸æ“‡å¤šå€‹ä¾†æº <code>.xlsx</code> æª”æ¡ˆï¼Œå·¥å…·æœƒè‡ªå‹•å®Œæˆåˆä½µã€æ‹†åˆ†ä¸¦ç”¢ç”Ÿå…©å€‹ä¸‹è¼‰é€£çµã€‚</p>
        
                <label for="files-merge-split" class="action-label">é¸æ“‡å¤šå€‹ Excel (.xlsx) æª”æ¡ˆ</label>
                <input type="file" id="files-merge-split" multiple accept=".xlsx" style="display:none;">
                <span id="file-count-merge-split" style="margin-left: 10px; font-size: 20px; color: #ed4242;"></span>

                <div class="options-group">
                    <p>å ±è¡¨æ—¥æœŸé¸é …:</p>
                    <input type="radio" id="date-today-merge-split" name="date-option-merge-split" value="today" checked>
                    <label for="date-today-merge-split">ä½¿ç”¨ä»Šå¤©æ—¥æœŸ</label>
                    <input type="radio" id="date-specify-merge-split" name="date-option-merge-split" value="specify">
                    <label for="date-specify-merge-split">æŒ‡å®šæ—¥æœŸ:</label>
                    <input type="date" id="specified-date-merge-split" disabled>
                </div>

                <button id="start-merge-split-btn">é–‹å§‹è™•ç†ä¸¦ä¸‹è¼‰æª”æ¡ˆ</button>
                <div id="status-merge-split" class="status"></div>
                
                <div id="download-area-merge-split" class="download-links-container" style="display: none;"></div>
            </div>
        </div>
    </div>
	
	<div id="custom-alert"></div>

    <script>
        // =========================================================================
        // --- ğŸŒŸ å…¨åŸŸ: è‡ªè¨‚è¨Šæ¯æç¤ºæ¡† (Custom Alert) å‡½æ•¸ ---
        // =========================================================================
        let alertTimeout;

        /**
         * é¡¯ç¤ºè‡ªè¨‚è¨Šæ¯æç¤ºæ¡† (Toast/Snackbar)
         * @param {string} message - è¦é¡¯ç¤ºçš„è¨Šæ¯å…§å®¹ã€‚
         * @param {'success' | 'error' | 'info'} type - è¨Šæ¯é¡å‹ï¼Œå½±éŸ¿èƒŒæ™¯é¡è‰²ã€‚
         */
        function showCustomAlert(message, type = 'info') {
            const alertBox = document.getElementById('custom-alert');
            
            // æ¸…é™¤ç¾æœ‰çš„è¨ˆæ™‚å™¨ï¼Œé¿å…å¤šå€‹è¨Šæ¯åŒæ™‚å‡ºç¾
            clearTimeout(alertTimeout);
            
            // è¨­ç½®å…§å®¹å’Œæ¨£å¼
            alertBox.textContent = message;
            alertBox.className = ''; // æ¸…é™¤æ‰€æœ‰èˆŠé¡åˆ¥
            alertBox.classList.add(type);
            alertBox.classList.add('show');
            
            // è¨­ç½®è‡ªå‹•éš±è—
            alertTimeout = setTimeout(() => {
                alertBox.classList.remove('show');
            }, 3000); // 3 ç§’å¾Œéš±è—
        }


        // =========================================================================
        // --- é ç±¤åˆ‡æ›ç¸½æ§åˆ¶ ---
        // =========================================================================
        function setupTabs(tabLinksSelector, tabContentSelector) {
            const tabs = document.querySelectorAll(tabLinksSelector);
            const contents = document.querySelectorAll(tabContentSelector);
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetId = tab.getAttribute('data-tab');
                    tabs.forEach(t => t.classList.remove('active'));
                    contents.forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupTabs('.tab-container .tab-link', '.content-container .tab-content');
        });

        
        // =========================================================================
        // --- å·¥å…·ä¸€: CSV/ZIP è¡¨è™Ÿæ¯”å°é‚è¼¯ (æ–°åŠŸèƒ½) ---
        // =========================================================================
		(function() {
			// æ‰€æœ‰ ID å¸¶ä¸Š -compare å¾Œç¶´
			const dropZone = document.getElementById('drop-zone');
			const status = document.getElementById('status-compare');
			const resultBody = document.getElementById('result-body-compare');
			const copyBtn = document.getElementById('copy-btn-compare');
			
			// *** æ–°å¢ï¼šXLSX ä¸‹è¼‰æŒ‰éˆ• DOM å…ƒç´  ***
			const downloadXlsxBtn = document.getElementById('download-xlsx-btn-compare'); 
            
            // ğŸŒŸ æ–°å¢ï¼šç¯©é¸ç›¸é—œ DOM å…ƒç´ 
            const hescodeFilter = document.getElementById('hescode-filter'); 
            const filteredCountSpan = document.getElementById('filtered-count');

			// åˆå§‹ç‹€æ…‹é¡¯ç¤º
			status.style.display = 'block';
			resultBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">çµæœå°‡é¡¯ç¤ºæ–¼æ­¤</td></tr>';
			copyBtn.style.display = 'none';
			
			// *** åˆå§‹éš±è— XLSX æŒ‰éˆ• ***
			if (downloadXlsxBtn) {
				downloadXlsxBtn.style.display = 'none';
			}
            
            // ğŸŒŸ æ¸…ç©ºç¯©é¸å™¨
            if (hescodeFilter) {
                hescodeFilter.innerHTML = '<option value="all">æ‰€æœ‰ Hescode</option>';
            }

			// *** æ–°å¢æ¬„ä½åˆ¥åå®šç¾© ***
			const FIELD_MAPPING = {
				'meter_id': ['meter_id', 'è¡¨è™Ÿ'],
				'cust_id': ['cust_id', 'é›»è™Ÿ'],
				'hescode': ['hescode'], 
                // ğŸŒŸ æ–°å¢: éœ€é‡(T/F) æ¬„ä½
                'demand': ['demand', 'éœ€é‡', 'éœ€é‡(t/f)', 'éœ€é‡(T/F)']
			};
			// ************************
			
			// å„²å­˜æ¯”å°çµæœï¼Œä¾›ä¸‹è¼‰ä½¿ç”¨
			// ğŸŒŸ å„²å­˜**æ‰€æœ‰**æœªç¯©é¸çš„çµæœ
			let allMissingEntries = []; 
            // ğŸŒŸ å„²å­˜**ç›®å‰**ç¯©é¸å¾Œçš„çµæœ
            let currentFilteredEntries = [];

			// --- 1. è¨­å®šæ‹–æ›³äº‹ä»¶ç›£è½ (ä¸è®Š) ---
			dropZone.addEventListener('dragover', (e) => {
				e.preventDefault(); 
				dropZone.classList.add('dragover');
			});
			dropZone.addEventListener('dragleave', (e) => {
				e.preventDefault();
				dropZone.classList.remove('dragover');
			});
			dropZone.addEventListener('drop', (e) => {
				e.preventDefault();
				dropZone.classList.remove('dragover');
				handleFiles(e.dataTransfer.files);
			});
            
            // --- 6.3 ğŸŒŸ æ–°å¢ï¼šç¯©é¸å™¨è®Šæ›´äº‹ä»¶ç›£è½ ---
            if (hescodeFilter) {
                hescodeFilter.addEventListener('change', (e) => {
                    // åªæœ‰åœ¨æœ‰è³‡æ–™æ™‚æ‰é€²è¡Œç¯©é¸
                    if (allMissingEntries.length > 0) {
                        filterAndDisplayResults(allMissingEntries, e.target.value);
                    }
                });
            }

			// --- 2. è™•ç†æ‹–æ”¾çš„æª”æ¡ˆ (ä¸è®Š) ---
			async function handleFiles(files) {
				if (files.length !== 2) {
					status.textContent = 'éŒ¯èª¤ï¼šè«‹å‹™å¿…åŒæ™‚æ‹–æ›³ 2 å€‹æª”æ¡ˆ (ä¸€å€‹ CSV/TSV å’Œä¸€å€‹ ZIP)';
					status.style.color = 'red';
					return;
				}

				let csvFile = null; 
				let zipFile = null;

				for (const file of files) {
					const lowerName = file.name.toLowerCase();
					if (lowerName.endsWith('.csv') || lowerName.endsWith('.tsv') || lowerName.endsWith('.txt')) {
						csvFile = file;
					} else if (lowerName.endsWith('.zip')) {
						zipFile = file;
					}
				}

				if (!csvFile || !zipFile) {
					status.textContent = 'éŒ¯èª¤ï¼šå¿…é ˆåŒ…å«ä¸€å€‹ .zip æª”æ¡ˆå’Œä¸€å€‹ .csv (æˆ– .tsv, .txt) æª”æ¡ˆ';
					status.style.color = 'red';
					return;
				}

				// åŸ·è¡Œå‰é‡ç½®
				status.textContent = 'æ­£åœ¨æº–å‚™è™•ç†...';
				status.style.color = 'blue';
				resultBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">æ­£åœ¨è™•ç†ä¸­...</td></tr>';
				copyBtn.style.display = 'none';
				if (downloadXlsxBtn) downloadXlsxBtn.style.display = 'none'; // é‡ç½® XLSX æŒ‰éˆ•
                if (hescodeFilter) hescodeFilter.innerHTML = '<option value="all">æ‰€æœ‰ Hescode</option>';
                if (filteredCountSpan) filteredCountSpan.textContent = '';


				try {
					status.textContent = 'æ­¥é©Ÿ 1/4: æ­£åœ¨è®€å– CSV/TSV æª”æ¡ˆ...';
					const csvData = await parseCSV(csvFile, FIELD_MAPPING); 

					status.textContent = 'æ­¥é©Ÿ 2/4: æ­£åœ¨è®€å– ZIP æª”æ¡ˆ... (æ­¤æ­¥é©Ÿå¯èƒ½è€—æ™‚è¼ƒä¹…)';
					const zipNamesSet = await parseZIP(zipFile);
					
					status.textContent = 'æ­¥é©Ÿ 3/4: æ­£åœ¨æ¯”è¼ƒè³‡æ–™... (è³‡æ–™é‡å¤§æ™‚å¯èƒ½è€—æ™‚)';
					let missingEntries = compareData(csvData, zipNamesSet);
					
					// ğŸŒŸ æ–°å¢ï¼šå¤šé‡æ¢ä»¶æ’åºæ­¥é©Ÿ
					status.textContent = 'æ­¥é©Ÿ 3.5/4: æ­£åœ¨ä¾ Hescode åŠéœ€é‡(T/F) æ’åº...';
					missingEntries = sortMissingEntries(missingEntries);


					status.textContent = 'æ­¥é©Ÿ 4/4: æ­£åœ¨ç”¢ç”Ÿçµæœé é¢...';
					displayResults(missingEntries); 

				} catch (error) {
					console.error('è™•ç†æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
					status.textContent = `éŒ¯èª¤: ${error.message} (è«‹æª¢æŸ¥æª”æ¡ˆæ ¼å¼ã€æ¬„ä½åç¨±æˆ–æ˜¯å¦å·²ä¸‹è¼‰ jszip.min.js å’Œ papaparse.min.js)`;
					status.style.color = 'red';
					resultBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">${error.message}</td></tr>`;
				}
			}

			// --- 3. è§£æ CSV æª”æ¡ˆ (æ–°å¢ demand æ¬„ä½æ“·å–) (ä¿æŒä¸è®Š) ---
			function parseCSV(file, mapping) {
				return new Promise((resolve, reject) => {
					Papa.parse(file, {
						delimiter: "\t", 
						skipEmptyLines: true,
						encoding: "UTF-8", 
						header: true, 
						transformHeader: (header) => String(header).trim().toLowerCase(), 
						complete: (results) => {
							try {
								const headerNames = results.meta.fields || [];
								const mappedFields = {};

								for (const targetField in mapping) {
									const aliases = mapping[targetField];
									const foundHeader = aliases.find(alias => {
										return headerNames.includes(String(alias).trim().toLowerCase());
									});
									
									if (foundHeader) {
										mappedFields[targetField] = String(foundHeader).trim();
									}
								}

								if (!mappedFields.meter_id) {
									return reject(new Error('CSV æª”æ¡ˆä¸­æœªæ‰¾åˆ°ã€ŒMeter IDã€æˆ–ã€Œè¡¨è™Ÿã€æ¬„ä½ã€‚'));
								}
								if (!mappedFields.cust_id) { mappedFields.cust_id = null; }
								if (!mappedFields.hescode) { mappedFields.hescode = null; }
                                if (!mappedFields.demand) { mappedFields.demand = null; }


								const mappedData = results.data
									.filter(row => row[mappedFields.meter_id]) 
									.map(row => {
										const meterId = row[mappedFields.meter_id] ? String(row[mappedFields.meter_id]).trim().toUpperCase() : ''; 
										if (!meterId) return null;

										return {
											cust_id: mappedFields.cust_id ? (row[mappedFields.cust_id] ? String(row[mappedFields.cust_id]).trim() : '') : '',
											meter_id: meterId,
											hescode: mappedFields.hescode ? (row[mappedFields.hescode] ? String(row[mappedFields.hescode]).trim() : '') : '',
                                            demand: mappedFields.demand ? (row[mappedFields.demand] ? String(row[mappedFields.demand]).trim().toUpperCase() : '') : ''
										};
									})
									.filter(item => item !== null);

								console.log(`CSV è®€å–å®Œç•¢ï¼Œå…± ${mappedData.length} ç­†æœ‰æ•ˆè³‡æ–™ã€‚å·²è‡ªå‹•é…å°çš„æ¬„ä½:`, mappedFields);
								resolve(mappedData);

							} catch (e) {
								reject(new Error(`CSV æª”æ¡ˆè™•ç†éŒ¯èª¤: ${e.message}`));
							}
						},
						error: (err) => {
							reject(new Error(`CSV è§£æå¤±æ•—: ${err.message}`));
						}
					});
				});
			}

			// --- 4. è§£æ ZIP æª”æ¡ˆ (ä¿æŒä¸è®Š) ---
			async function parseZIP(file) {
				const zip = await JSZip.loadAsync(file);
				const namesSet = new Set();
				const regex = /<name>([A-Za-z0-9]{10})<\/name>/g; 
				const xmlFiles = [];
				
				zip.forEach((relativePath, zipEntry) => {
					if (zipEntry.name.toLowerCase().endsWith('.xml') && !zipEntry.dir) {
						xmlFiles.push(zipEntry);
					}
				});

				if (xmlFiles.length === 0) {
					console.warn("ZIP æª”æ¡ˆä¸­æœªæ‰¾åˆ°ä»»ä½• .xml æª”æ¡ˆ");
				}

				let processedCount = 0;
				for (const xmlFile of xmlFiles) {
					processedCount++;
					status.textContent = `æ­¥é©Ÿ 2/4: æ­£åœ¨è™•ç† ZIP... (${processedCount} / ${xmlFiles.length} å€‹ XML æª”æ¡ˆ)`;
					
					try {
						const content = await xmlFile.async('string');
						let match;
						while ((match = regex.exec(content)) !== null) {
							namesSet.add(match[1].trim().toUpperCase()); 
						}
					} catch (err) {
						console.error(`è™•ç† ${xmlFile.name} æ™‚å‡ºéŒ¯:`, err);
						console.warn(`è·³é ${xmlFile.name} æª”æ¡ˆ`);
					}
				}
				
				console.log(`ZIP è®€å–å®Œç•¢ï¼Œå…±æ‰¾åˆ° ${namesSet.size} å€‹å”¯ä¸€çš„ <name> ID`);
				return namesSet;
			}

			// --- 5. æ¯”è¼ƒè³‡æ–™ (ä¿æŒä¸è®Š) ---
			function compareData(csvData, zipNamesSet) {
				const missing = csvData.filter(csvRow => {
					return csvRow && csvRow.meter_id && !zipNamesSet.has(csvRow.meter_id);
				});
				return missing;
			}
			
			// --- 5.5. å¤šé‡æ¢ä»¶æ’åº (ä¿æŒä¸è®Š) ---
			function sortMissingEntries(entries) {
				return entries.sort((a, b) => {
					// 1. ä¸»è¦æ’åºéµ: hescode
					const hescodeA = a.hescode || '';
					const hescodeB = b.hescode || '';
					if (hescodeA < hescodeB) return -1;
					if (hescodeA > hescodeB) return 1;

					// 2. æ¬¡è¦æ’åºéµ: demand (éœ€é‡T/F)
					const demandA = a.demand || '';
					const demandB = b.demand || '';
					
					// ç‚ºäº†ç¢ºä¿ä¸€è‡´çš„ T/F æ’åºé‚è¼¯ï¼ˆTåœ¨å‰ï¼ŒFåœ¨å¾Œï¼‰
					if (demandA.toUpperCase() === 'T' && demandB.toUpperCase() === 'F') return -1;
					if (demandA.toUpperCase() === 'F' && demandB.toUpperCase() === 'T') return 1;
					if (demandA.toUpperCase() < demandB.toUpperCase()) return -1;
					if (demandA.toUpperCase() > demandB.toUpperCase()) return 1;

					// 3. å‚™ç”¨æ’åºéµ: meter_id
					const meterA = a.meter_id || '';
					const meterB = b.meter_id || '';
					if (meterA < meterB) return -1;
					if (meterA > meterB) return 1;
					
					return 0; // å®Œå…¨ç›¸åŒ
				});
			}


			// --- 6. é¡¯ç¤ºçµæœ (æ›´æ–°ä»¥è™•ç†ç¯©é¸é‚è¼¯) ---
			function displayResults(missingEntries) {
                
                // è™•ç†å…¨éƒ¨ç¬¦åˆçš„æƒ…æ³
				if (missingEntries.length === 0) {
					status.textContent = 'æ¯”å°å®Œæˆï¼šå…¨éƒ¨ç¬¦åˆï¼ CSV ä¸­çš„æ‰€æœ‰ Meter ID å‡å¯åœ¨ ZIP æª”æ¡ˆä¸­æ‰¾åˆ°ã€‚';
					status.style.color = 'green';
					resultBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ç„¡å·®ç•°è³‡æ–™ (å…¨éƒ¨ç¬¦åˆ)</td></tr>';
					copyBtn.style.display = 'none';
					if (downloadXlsxBtn) downloadXlsxBtn.style.display = 'none'; 
                    // ğŸŒŸ æ¸…ç©ºç¯©é¸å™¨
                    if (hescodeFilter) hescodeFilter.innerHTML = '<option value="all">æ‰€æœ‰ Hescode</option>';
					if (filteredCountSpan) filteredCountSpan.textContent = '';
					showCustomAlert('æ¯”å°å®Œæˆï¼šå…¨éƒ¨ç¬¦åˆï¼', 'success');
					return;
				}
                
                // å„²å­˜**æ‰€æœ‰**çµæœ (å·²æ’åº)
                allMissingEntries = missingEntries; 
                
                // 1. æ›´æ–°ç‹€æ…‹
				status.textContent = `æ¯”å°å®Œæˆï¼šåœ¨ CSV ä¸­æ‰¾åˆ° ${allMissingEntries.length} ç­†è³‡æ–™ä¸å­˜åœ¨æ–¼ ZIP æª”æ¡ˆä¸­ã€‚`;
				status.style.color = 'darkorange';

                // 2. ğŸŒŸ å¡«å……ç¯©é¸å™¨ä¸¦æ‡‰ç”¨åˆå§‹ç¯©é¸ï¼ˆå…¨éƒ¨ï¼‰
                populateHescodeFilter(allMissingEntries);
                filterAndDisplayResults(allMissingEntries, hescodeFilter.value); // é è¨­ç¯©é¸æ‰€æœ‰

				// 3. ğŸŒŸ è¨­å®š XLSX ä¸‹è¼‰æŒ‰éˆ• (ç¶­æŒä¸‹è¼‰å…¨éƒ¨)
				if (downloadXlsxBtn) {
					downloadXlsxBtn.style.display = 'block';
					downloadXlsxBtn.onclick = () => {
						downloadXLSX(allMissingEntries); // ä¸‹è¼‰ **æ‰€æœ‰** å·®ç•°è³‡æ–™
					};
				}
			}
            
            // --- 6.1 ğŸŒŸ æ–°å¢ï¼šå¡«å…… Hescode ç¯©é¸å™¨ ---
            function populateHescodeFilter(entries) {
                const uniqueHescodes = new Set();
                entries.forEach(entry => {
                    // ç¢ºä¿åªåŠ å…¥æœ‰æ•ˆçš„ hescode
                    if (entry.hescode && String(entry.hescode).trim() !== '') {
                        uniqueHescodes.add(entry.hescode);
                    }
                });
                
                const sortedHescodes = Array.from(uniqueHescodes).sort();
                
                let optionsHtml = '<option value="all">æ‰€æœ‰ Hescode</option>';
                sortedHescodes.forEach(code => {
                    optionsHtml += `<option value="${code}">${code}</option>`;
                });
                
                hescodeFilter.innerHTML = optionsHtml;
                hescodeFilter.value = 'all'; // é‡è¨­ç‚º 'æ‰€æœ‰'
            }

            // --- 6.2 ğŸŒŸ æ–°å¢ï¼šç¯©é¸ä¸¦é¡¯ç¤ºçµæœåˆ°è¡¨æ ¼ (åŒæ™‚æ›´æ–°è¤‡è£½æŒ‰éˆ•é‚è¼¯) ---
            function filterAndDisplayResults(allEntries, selectedHescode) {
                let entriesToDisplay = allEntries;
                
                if (selectedHescode && selectedHescode !== 'all') {
                    entriesToDisplay = allEntries.filter(entry => entry.hescode === selectedHescode);
                }
                
                // ğŸŒŸ å„²å­˜ç¯©é¸å¾Œçš„çµæœä¾›è¤‡è£½åŠŸèƒ½ä½¿ç”¨
                currentFilteredEntries = entriesToDisplay; 
                
                // æ›´æ–°è¨ˆæ•¸é¡¯ç¤º
                if (filteredCountSpan) filteredCountSpan.textContent = `(å…± ${currentFilteredEntries.length} ç­†)`;
                
                // --- ğŸŒŸ è¨­å®šè¤‡è£½æŒ‰éˆ• (åƒ…è¤‡è£½ç¯©é¸å¾Œçš„é›»è™Ÿ+è¡¨è™Ÿ) ---
                let copyString = "";
                currentFilteredEntries.forEach(entry => {
                    copyString += `${entry.cust_id}\t${entry.meter_id}\n`;
                });
                
                copyBtn.style.display = 'block'; 
                copyBtn.onclick = () => {
                    // ğŸŒŸ åƒ…è¤‡è£½ é›»è™Ÿ (cust_id) å’Œ è¡¨è™Ÿ (meter_id)
                    if (currentFilteredEntries.length === 0) {
                        showCustomAlert('ç›®å‰ç¯©é¸çµæœç‚ºç©ºï¼Œç„¡æ³•è¤‡è£½ã€‚', 'error');
                        return;
                    }
                    navigator.clipboard.writeText(copyString).then(() => {
                        showCustomAlert(`å·²è¤‡è£½ ${currentFilteredEntries.length} ç­†è³‡æ–™åˆ°å‰ªè²¼ç°¿ (åƒ…é›»è™Ÿ/è¡¨è™Ÿ)`, 'success');
                    }, (err) => {
                        showCustomAlert('è¤‡è£½å¤±æ•—! è«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™ã€‚', 'error');
                    });
                };
                
                // --- æ¸²æŸ“è¡¨æ ¼ ---
                resultBody.innerHTML = ''; 
                
                if (entriesToDisplay.length === 0) {
                    resultBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">ç„¡ç¬¦åˆç¯©é¸æ¢ä»¶çš„è³‡æ–™</td></tr>';
                    return;
                }
                
                // ... (æ¸²æŸ“é‚è¼¯ä¿æŒä¸è®Š) ...
                const RENDER_LIMIT = 1000;
				const entriesToRender = entriesToDisplay.slice(0, RENDER_LIMIT);
				
				// ç¢ºä¿ç‹€æ…‹åˆ—æ­£ç¢ºé¡¯ç¤ºç¸½æ•¸
				let currentStatusText = status.textContent.split(' (ç‚ºé˜²æ­¢')[0];
				if (entriesToDisplay.length > RENDER_LIMIT) {
					currentStatusText += ` (ç‚ºé˜²æ­¢ç€è¦½å™¨ç•¶æ©Ÿï¼Œé é¢åƒ…é¡¯ç¤ºå‰ ${RENDER_LIMIT} ç­†ï¼Œä½† "ä¸€éµè¤‡è£½" å’Œ "ä¸‹è¼‰ XLSX" åŠŸèƒ½æœƒåŒ…å«æ‰€æœ‰ ${entriesToDisplay.length} ç­†)`;
				}
				status.textContent = currentStatusText;


				// æ¸²æŸ“è³‡æ–™
				entriesToRender.forEach(entry => {
					const tr = document.createElement('tr');
					
					const tdCustId = document.createElement('td');
					tdCustId.textContent = entry.cust_id;
					tr.appendChild(tdCustId);

					const tdMeterId = document.createElement('td');
					tdMeterId.textContent = entry.meter_id;
					tr.appendChild(tdMeterId);

					const tdHescode = document.createElement('td');
					tdHescode.textContent = entry.hescode;
					tr.appendChild(tdHescode);
					
                    const tdDemand = document.createElement('td');
					tdDemand.textContent = entry.demand;
					tr.appendChild(tdDemand);
					
					resultBody.appendChild(tr);
				});
            }
			
			// --- 7. ä¸‹è¼‰ XLSX (ç¶­æŒä¸‹è¼‰å…¨éƒ¨) ---
			function downloadXLSX(data) {
				if (typeof XLSX === 'undefined') {
					showCustomAlert('éŒ¯èª¤ï¼šç¼ºå°‘ XLSX å‡½å¼åº«ã€‚è«‹ç¢ºä¿æ‚¨çš„é é¢å·²è¼‰å…¥ xlsx.full.min.js', 'error');
					return;
				}

                // ğŸŒŸ ä½¿ç”¨å‚³å…¥çš„ data (allMissingEntries)
				const header = ['Cust ID', 'Meter ID', 'HES Code', 'éœ€é‡(T/F)'];
				
				const exportData = [header, ...data.map(item => [item.cust_id, item.meter_id, item.hescode, item.demand])];
				
				const ws = XLSX.utils.aoa_to_sheet(exportData);
				const wb = XLSX.utils.book_new();
				XLSX.utils.book_append_sheet(wb, ws, "æ¯”å°çµæœ");
				
				const date = new Date().toISOString().slice(0, 10);
				XLSX.writeFile(wb, `æ¯”å°å·®ç•°çµæœ_${date}.xlsx`);
			}

		})();

        // =========================================================================
        // --- å·¥å…·äºŒ: XML è¡¨è™Ÿè§£æé‚è¼¯ ---
        // =========================================================================
		(function() {
			// åŸå§‹å…ƒç´ 
			const folderInput = document.getElementById('folder-input-xml');
			const zipInput = document.getElementById('zip-input-xml');
			const clearBtn = document.getElementById('clear-btn-xml');
			const statusElement = document.getElementById('status-xml');
			const downloadArea = document.getElementById('download-area-xml');
			const resultsDisplayElement = document.getElementById('results-display-xml');
			const copyBtn = document.getElementById('copy-btn-xml');

			// **æ–°å¢ï¼šæ‹–æ›³å€åŸŸçš„ DOM å…ƒç´ **
			const dropArea = document.getElementById('drop-area-xml'); // å‡è¨­æ‚¨çš„æ‹–æ›³å€å¡Š ID ç‚º drop-area-xml

			let cumulativeCsvData = [];
			const regex = /<name>([A-Za-z0-9]{10})<\/name>/g;

			function escapeCsvField(field) {
				const str = String(field || '');
				if (str.includes(',') || str.includes('"') || str.includes('\n')) {
					return `"${str.replace(/"/g, '""')}"`;
				}
				return str;
			}

			function updateUIWithResults() {
				if (cumulativeCsvData.length > 0) {
					const displayableResults = cumulativeCsvData.map(row => row[2]);
					resultsDisplayElement.textContent = displayableResults.join('\n');

					const headers = ['ä¾†æº (è³‡æ–™å¤¾/å£“ç¸®æª”)', 'å…§éƒ¨è·¯å¾‘/æª”å', 'è¡¨è™Ÿ'];
					let csvContent = headers.map(escapeCsvField).join(',') + '\n';
					csvContent += cumulativeCsvData.map(row => row.map(escapeCsvField).join(',')).join('\n');
					const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8-sig' });
					const url = URL.createObjectURL(blob);

					downloadArea.innerHTML = `<a href="${url}" download="combined_results.csv">é»æ­¤ä¸‹è¼‰åˆä½µå¾Œçš„ CSV (${cumulativeCsvData.length}ç­†)</a>`;
					downloadArea.style.display = 'flex';
					copyBtn.style.display = 'inline-block';
					clearBtn.style.display = 'block';
				} else {
					resultsDisplayElement.textContent = 'ç­‰å¾…è™•ç†...';
					downloadArea.style.display = 'none';
					copyBtn.style.display = 'none';
					clearBtn.style.display = 'none';
				}
			}

			async function processXmlContent(content, sourceName, filePath, tempData) {
				const matches = Array.from(content.matchAll(regex), match => match[1]);
				if (matches.length > 0) {
					matches.forEach(result => {
						tempData.push([sourceName, filePath, result]);
					});
				}
			}

			async function processZipFile(file, tempData) {
				const content = await file.arrayBuffer();
				// ğŸš¨ ç¢ºä¿æ‚¨çš„é é¢å·²è¼‰å…¥ JSZip å‡½å¼åº«ï¼Œå¦å‰‡é€™è£¡æœƒå ±éŒ¯
				const zip = await JSZip.loadAsync(content); 
				const xmlFilePromises = [];
				zip.forEach((_, zipEntry) => {
					if (zipEntry.name.toLowerCase().endsWith('.xml') && !zipEntry.dir) {
						const promise = zipEntry.async("string").then(xmlContent => {
							return processXmlContent(xmlContent, file.name, zipEntry.name, tempData);
						});
						xmlFilePromises.push(promise);
					}
				});
				await Promise.all(xmlFilePromises);
			}

			async function handleSelection(files) {
				if (!files || files.length === 0) return;
				statusElement.style.display = 'block';
				statusElement.textContent = `é–‹å§‹è™•ç† ${files.length} å€‹é …ç›®...`;
				const tempData = [];
				const processingPromises = [];
				for (const file of files) {
					if (file.type === 'application/zip' || file.name.toLowerCase().endsWith('.zip')) {
						processingPromises.push(processZipFile(file, tempData));
					} else if (file.name.toLowerCase().endsWith('.xml')) {
						// æ‹–æ›³ä¸Šå‚³çš„æª”æ¡ˆé€šå¸¸æ²’æœ‰ webkitRelativePathï¼Œå› æ­¤ä½¿ç”¨ 'å–®ä¸€æª”æ¡ˆ/æ‹–æ›³' ä½œç‚ºä¾†æºå€åˆ†
						const source = file.webkitRelativePath.split('/')[0] || 'æ‹–æ›³ä¸Šå‚³'; 
						const promise = file.text().then(content => {
							processXmlContent(content, source, file.webkitRelativePath || file.name, tempData);
						});
						processingPromises.push(promise);
					}
				}
				await Promise.all(processingPromises);
				cumulativeCsvData = cumulativeCsvData.concat(tempData);
				statusElement.textContent = `è™•ç†å®Œæˆï¼æœ¬æ¬¡æ–°å¢ ${tempData.length} ç­†çµæœï¼Œç¸½å…± ${cumulativeCsvData.length} ç­†ã€‚`;
				updateUIWithResults();
			}

			// ====================================================================
			// ğŸŒŸ æ–°å¢ï¼šæ‹–æ›³ä¸Šå‚³åŠŸèƒ½
			// ====================================================================
			function preventDefaults(e) {
				e.preventDefault();
				e.stopPropagation();
			}

			function handleDrop(e) {
				const dt = e.dataTransfer;
				const files = dt.files;
				
				// å‘¼å«ç¾æœ‰çš„æª”æ¡ˆè™•ç†é‚è¼¯
				handleSelection(files);
			}

			if (dropArea) {
				// 1. é˜²æ­¢ç€è¦½å™¨é–‹å•Ÿæ‹–æ›³é€²ä¾†çš„æª”æ¡ˆï¼ˆé è¨­è¡Œç‚ºï¼‰
				['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
					dropArea.addEventListener(eventName, preventDefaults, false);
				});

				// 2. æä¾›è¦–è¦ºå›é¥‹ï¼šæ»‘é¼ åœ¨ä¸Šæ–¹æ™‚è®Šäº®
				['dragenter', 'dragover'].forEach(eventName => {
					dropArea.addEventListener(eventName, () => dropArea.classList.add('highlight'), false);
				});
				['dragleave', 'drop'].forEach(eventName => {
					dropArea.addEventListener(eventName, () => dropArea.classList.remove('highlight'), false);
				});

				// 3. è™•ç†æ”¾ä¸‹æª”æ¡ˆ
				dropArea.addEventListener('drop', handleDrop, false);
			}
			// ====================================================================


			// åŸå§‹çš„äº‹ä»¶ç›£è½å™¨ä¿æŒä¸è®Š
			folderInput.addEventListener('change', (e) => handleSelection(e.target.files));
			zipInput.addEventListener('change', (e) => handleSelection(e.target.files));

			clearBtn.addEventListener('click', () => {
				cumulativeCsvData = [];
				statusElement.textContent = 'çµæœå·²æ¸…é™¤ã€‚';
				updateUIWithResults();
			});
			
			copyBtn.addEventListener('click', async () => {
				if (!navigator.clipboard) { alert('æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´è¤‡è£½åŠŸèƒ½ã€‚'); return; }
				const originalText = copyBtn.textContent;
				try {
					await navigator.clipboard.writeText(resultsDisplayElement.textContent);
					copyBtn.textContent = 'å·²è¤‡è£½ï¼';
				} catch (err) { copyBtn.textContent = 'è¤‡è£½å¤±æ•—'; } 
				finally { setTimeout(() => { copyBtn.textContent = originalText; }, 2000); }
			});
		})();

        // =========================================================================
        // --- å·¥å…·ä¸‰: ZIP ä¸­ç¹¼æª”è§£æé‚è¼¯ ---
        // =========================================================================
        (function() {
            const zipFileInput = document.getElementById('zipFile-zip');
            const statusElement = document.getElementById('status-zip');
            const downloadArea = document.getElementById('download-area-zip');
            
            function generateExcelDownloadLink(data, filename) {
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(wb, ws, "åˆ†çµ„çµæœ");
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                downloadArea.innerHTML = `<a href="${url}" download="${filename}">é»æ­¤ä¸‹è¼‰ Excel æª”æ¡ˆ (${filename})</a>`;
                downloadArea.style.display = 'flex';
            }
            
            function handleError(message, error) {
                statusElement.textContent = message;
                if (error) console.error("ZIP å·¥å…·éŒ¯èª¤:", error);
            }
            
            zipFileInput.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                statusElement.style.display = 'block';
                statusElement.textContent = 'æ­£åœ¨è®€å– ZIP æª”æ¡ˆ...';
                downloadArea.style.display = 'none';
                try {
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const content = e.target.result;
                            const zip = await JSZip.loadAsync(content);
                            const rawData = [];
                            const txtFiles = [];
                            zip.forEach((_, zipEntry) => {
                                if (zipEntry.name.toLowerCase().endsWith('.txt') && !zipEntry.dir) {
                                    txtFiles.push(zipEntry);
                                }
                            });
                            if (txtFiles.length === 0) {
                                throw new Error('åœ¨ ZIP æª”æ¡ˆä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½• .txt æª”æ¡ˆã€‚');
                            }
                            for (const fileEntry of txtFiles) {
                                statusElement.textContent = `æ“·å–ä¸­: ${fileEntry.name}`;
                                const fileContent = await fileEntry.async("string");
                                const lines = fileContent.split(/\r?\n/);
                                for (const line of lines) {
                                    if (line.length >= 47) {
                                        const denGo = line.slice(3, 14).trim();
                                        const hyoGo = (line.slice(36, 38) + line.slice(39, 47)).trim();
                                        const hyoBetsu = line.slice(14, 16).trim();
                                        rawData.push({ denGo, hyoGo, hyoBetsu });
                                    }
                                }
                            }
                            statusElement.textContent = 'æ“·å–å®Œæˆï¼Œæ­£åœ¨é€²è¡Œåˆ†çµ„èˆ‡å½™ç¸½...';
                            const groupedData = new Map();
                            for (const item of rawData) {
                                const compositeKey = `${item.denGo}|${item.hyoGo}`;
                                if (!groupedData.has(compositeKey)) {
                                    groupedData.set(compositeKey, {
                                        denGo: item.denGo,
                                        hyoGo: item.hyoGo,
                                        hyoBetsuList: new Set()
                                    });
                                }
                                if (item.hyoBetsu) {
                                    groupedData.get(compositeKey).hyoBetsuList.add(item.hyoBetsu);
                                }
                            }
                            const excelData = [['é›»è™Ÿ', 'è¡¨è™Ÿ', 'è¡¨åˆ¥']];
                            let validCount = 0;
                            for (const group of groupedData.values()) {
                                const aggregatedHyoBetsu = Array.from(group.hyoBetsuList).join(',');
                                excelData.push([group.denGo, group.hyoGo, aggregatedHyoBetsu]);
                                validCount++;
                            }
                            if (validCount > 0) {
                                statusElement.textContent = `è™•ç†å®Œæˆï¼å…±ç”¢ç”Ÿ ${validCount} ç­†åˆ†çµ„è³‡æ–™ï¼Œæ­£åœ¨ç”Ÿæˆ Excel æª”æ¡ˆ...`;
                                generateExcelDownloadLink(excelData, 'grouped_data.xlsx');
                            } else {
                                statusElement.textContent = 'è™•ç†å®Œæˆï¼Œä½†åœ¨æ‰€æœ‰ .txt æª”æ¡ˆä¸­å‡æœªæ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å…§å®¹ã€‚';
                            }
                        } catch (err) {
                            handleError('è™•ç† ZIP æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚', err);
                        }
                    };
                    reader.onerror = () => { handleError('è®€å–æª”æ¡ˆå¤±æ•—ï¼'); };
                    reader.readAsArrayBuffer(file);
                } catch (err) { handleError('ç™¼ç”Ÿé æœŸå¤–çš„éŒ¯èª¤ã€‚', err); }
            });
        })();

        // =========================================================================
        // --- å·¥å…·å››: ä¾‹å¤–æ¸…å–®è™•ç†é‚è¼¯ (åˆä½µèˆ‡æ‹†åˆ†) ---
        // =========================================================================
		(function() {
			const fileInput = document.getElementById('files-merge-split');
			const startBtn = document.getElementById('start-merge-split-btn');
			const fileCountSpan = document.getElementById('file-count-merge-split');
			const statusDiv = document.getElementById('status-merge-split');
			const downloadArea = document.getElementById('download-area-merge-split');
			const specifiedDateInput = document.getElementById('specified-date-merge-split');

			// å€è™•å°æ‡‰è¡¨
			const sectionMap = { "00":"åŒ—å¸‚å€è™•", "01":"åŒ—å—å€è™•", "02":"åŸºéš†å€è™•", "03":"å®œè˜­å€è™•", "04":"æ¡ƒåœ’å€è™•", "05":"åŒ—è¥¿å€è™•", "06":"æ–°ç«¹å€è™•", "07":"å°ä¸­å€è™•", "08":"å½°åŒ–å€è™•", "09":"å˜‰ç¾©å€è™•", "10":"å°å—å€è™•", "11":"é«˜é›„å€è™•", "12":"å±æ±å€è™•", "13":"èŠ±è“®å€è™•", "14":"å°æ±å€è™•", "15":"æ¾æ¹–å€è™•", "16":"åŒ—åŒ—å€è™•", "17":"å—æŠ•å€è™•", "18":"é³³å±±å€è™•", "19":"é›²æ—å€è™•", "20":"æ–°ç‡Ÿå€è™•", "21":"è‹—æ —å€è™•", "22":"é‡‘é–€å€è™•", "23":"é¦¬ç¥–å€è™•" };

			function escapeCsvField(field) {
				const str = String(field == null ? '' : field);
				if (str.includes(',') || str.includes('"') || str.includes('\n') || str.includes('\r')) {
					const escapedStr = str.replace(/"/g, '""');
					return `"${escapedStr}"`;
				}
				return str;
			}
			
			// è™•ç†æ—¥æœŸè¼¸å…¥æ¡†çš„å•Ÿç”¨/ç¦ç”¨ç‹€æ…‹
			document.querySelectorAll('input[name="date-option-merge-split"]').forEach(radio => {
				radio.addEventListener('change', (e) => {
					specifiedDateInput.disabled = e.target.value !== 'specify';
				});
			});

			// é¡¯ç¤ºå·²é¸æª”æ¡ˆæ•¸é‡
			fileInput.addEventListener('change', (e) => {
				const files = e.target.files;
				if (files && files.length > 0) {
					fileCountSpan.textContent = `(${files.length} å€‹æª”æ¡ˆå·²é¸æ“‡)`;
				} else {
					fileCountSpan.textContent = '';
				}
			});

			startBtn.addEventListener('click', async () => {
				const files = fileInput.files;
				if (!files || files.length === 0) {
					showCustomAlert('è«‹å…ˆé¸æ“‡è¦è™•ç†çš„ Excel æª”æ¡ˆï¼', 'error');
					return;
				}
				
				const isSpecifyDate = document.getElementById('date-specify-merge-split').checked;
				const specifiedDate = specifiedDateInput.value;
				if (isSpecifyDate && !specifiedDate) {
					showCustomAlert('è‹¥é¸æ“‡ã€ŒæŒ‡å®šæ—¥æœŸã€ï¼Œè«‹å‹™å¿…å¡«å¯«æ—¥æœŸï¼', 'error');
					return;
				}

				statusDiv.style.display = 'block';
				statusDiv.textContent = `æ­¥é©Ÿ 1/3: æ­£åœ¨è®€å– ${files.length} å€‹æª”æ¡ˆ...`; // æ›´æ”¹æ­¥é©Ÿæ•¸
				downloadArea.style.display = 'none';

				try {
					// --- æ­¥é©Ÿ 1: è®€å–æ‰€æœ‰è³‡æ–™ä¸¦é™„åŠ æª”æ¡ˆä¿®æ”¹æ™‚é–“ ---
					let rawDataWithTime = [];
					const fileReadPromises = Array.from(files).map(file => {
						const fileModifiedTime = file.lastModified; // ç²å–æª”æ¡ˆçš„æœ€å¾Œä¿®æ”¹æ™‚é–“ä½œç‚ºåˆ¤æ–·æ–°èˆŠçš„ä¾æ“š
						
						return new Promise((resolve, reject) => {
							const reader = new FileReader();
							reader.onload = (e) => {
								try {
									const wb = XLSX.read(e.target.result, { type: 'array' });
									const ws = wb.Sheets[wb.SheetNames[0]];
									// header: 1 è®“è¼¸å‡ºç‚º Array of Arrays
									const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
									// å‡è¨­è³‡æ–™å¾ç¬¬ 5 è¡Œ (ç´¢å¼• 4) é–‹å§‹
									if (data.length > 4) {
										// å°‡è³‡æ–™èˆ‡æª”æ¡ˆä¿®æ”¹æ™‚é–“ä¸€èµ·å„²å­˜
										data.slice(4).forEach(row => {
											rawDataWithTime.push({
												data: row,
												lastModified: fileModifiedTime
											});
										});
									}
									resolve();
								} catch (err) { reject(err); }
							};
							reader.onerror = reject;
							reader.readAsArrayBuffer(file);
						});
					});
					await Promise.all(fileReadPromises);

					statusDiv.textContent = `æ­¥é©Ÿ 2/3: æ­£åœ¨åˆä½µã€æ¸…æ´—ä¸¦å»é‡ ${rawDataWithTime.length} ç­†è³‡æ–™...`;

					// --- æ­¥é©Ÿ 2: æ¸…æ´—ã€æ ¼å¼åŒ–èˆ‡å»é‡ (æ–°å¢å»é‡é‚è¼¯) ---
					const today = new Date();
					const y = today.getFullYear();
					const m = String(today.getMonth() + 1).padStart(2, '0');
					const d = String(today.getDate()).padStart(2, '0');
					const todayStr = `${y}-${m}-${d}`;
					const billingDate = isSpecifyDate ? specifiedDate : todayStr;
					
					// Map ä¾†è¿½è¹¤å”¯ä¸€çš„ key (é›»è™Ÿ_è¡¨è™Ÿ)
					const uniqueDataMap = new Map(); 

					rawDataWithTime
						.filter(item => item.data && item.data[0] && String(item.data[0]).trim() !== '') // ç¢ºä¿é›»è™Ÿæ¬„ä½ä¸ç‚ºç©º
						.forEach(item => {
							const row = item.data;
							const lastModified = item.lastModified;
							
							const custNo = String(row[0] || '');
							const meterNo = String(row[1] || '');
							
							// æ ¼å¼åŒ– cust_no ç‚º 11 ä½æ•¸ (å·¦é‚Šè£œ 0)
							const finalCustNo = ('00000000000' + custNo).slice(-11);
							
							const key = `${finalCustNo}_${meterNo}`;

							// exception_code é è¨­ç‚º 1
							const exceptionCode = (row[3] === null || row[3] === undefined || row[3] === '') ? 1 : row[3];
							
							const newRow = [
								finalCustNo, 
								row[1], // meter_no
								row[2], // address
								exceptionCode, 
								row[4], // description
								billingDate,
								lastModified // ç´€éŒ„æ™‚é–“æˆ³è¨˜ï¼Œç”¨æ–¼æ¯”è¼ƒæ–°èˆŠ
							];
							
							// å»é‡é‚è¼¯ï¼šå¦‚æœ key ä¸å­˜åœ¨ï¼Œæˆ–ç•¶å‰ row çš„æ™‚é–“æˆ³è¨˜æ¯”å·²å­˜åœ¨çš„ row æ–°ï¼Œå‰‡è¦†è“‹
							if (!uniqueDataMap.has(key) || uniqueDataMap.get(key)[6] < lastModified) {
								uniqueDataMap.set(key, newRow);
							}
						});

					// å°‡ Map è½‰æ›å›é™£åˆ—ï¼Œä¸¦ç§»é™¤æœ€å¾Œä¸€å€‹æ™‚é–“æˆ³è¨˜æ¬„ä½
					let processedData = Array.from(uniqueDataMap.values()).map(row => row.slice(0, 6)); 
					
					if (processedData.length === 0) {
						statusDiv.textContent = 'è™•ç†å®Œæˆï¼Œä½†æ²’æœ‰æ‰¾åˆ°æœ‰æ•ˆè³‡æ–™ã€‚è«‹ç¢ºèªæ‚¨çš„æª”æ¡ˆæ ¼å¼ (è³‡æ–™æ‡‰å¾ç¬¬ 5 è¡Œé–‹å§‹)ã€‚';
						return;
					}

					// ç”¢ç”Ÿ exception.csv ä¸‹è¼‰é€£çµ
					const csvHeaders = ["cust_no", "meter_no", "address", "exception_code", "description", "billing_date"];
					const csvContent = [csvHeaders, ...processedData].map(row => row.map(escapeCsvField).join(",")).join("\n");
					const csvBlob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8-sig' });
					const csvUrl = URL.createObjectURL(csvBlob);
					
					statusDiv.textContent = `æ­¥é©Ÿ 3/3: æ­£åœ¨æ ¹æ“šå€è™•æ‹†åˆ† ${processedData.length} ç­†å»é‡å¾Œè³‡æ–™...`;

					// --- æ­¥é©Ÿ 3: æ‹†åˆ†è³‡æ–™ä¸¦ç”Ÿæˆ ZIP (ä¿æŒä¸è®Š) ---
					const dataWithSection = processedData.map(row => {
						const custNo = String(row[0] || '');
						const sectionCode = custNo.substring(0, 2);
						const sectionName = sectionMap[sectionCode] || 'æœªçŸ¥å€è™•';
						const newRow = [...row];
						newRow.push(sectionName);
						return newRow; // åŒ…å« 7 å€‹æ¬„ä½ï¼Œæœ€å¾Œä¸€å€‹æ˜¯ sectionName
					});
					
					const sections = [...new Set(dataWithSection.map(row => row[6]))]; // row[6] æ˜¯ sectionName
					const zip = new JSZip();

					const reportDate = new Date(billingDate);
					const rocYear = reportDate.getFullYear() - 1911;
					const month = String(reportDate.getMonth() + 1).padStart(2, '0');
					const day = String(reportDate.getDate()).padStart(2, '0');
					const rocDateStr = `${rocYear}.${month}.${day}`;
					const yyyymmdd = `${reportDate.getFullYear()}${month}${day}`;
					const excelHeaders = ["é›»è™Ÿ", "è¡¨è™Ÿ", "ç”¨é›»åœ°å€", "æŠ„è¡¨ä¾‹å¤–ä»£è™Ÿ", "å‚™è¨»"];
					
					sections.forEach(section => {
						const sectionData = dataWithSection.filter(row => row[6] === section);
						if (sectionData.length > 0) {
							const sectionCode = Object.keys(sectionMap).find(key => sectionMap[key] === section) || "XX";

							const header1 = ["ä½å£“AMIæŠ„è¡¨ä¾‹å¤–æ¸…å–®", null, null, null, null];
							const header2 = [`å€è™•ï¼š[${sectionCode}]${section}`, null, null, null, null];
							const header3 = [`æŠ„è¡¨æ—¥ï¼š${rocDateStr}`, null, null, null, null];
							// æ“·å–å‰ 5 æ¬„ (é›»è™Ÿ, è¡¨è™Ÿ, åœ°å€, ä»£è™Ÿ, å‚™è¨»)
							const sheetData = [header1, header2, header3, excelHeaders, ...sectionData.map(row => row.slice(0, 5))];

							const wb = XLSX.utils.book_new();
							const ws = XLSX.utils.aoa_to_sheet(sheetData, { cellDates: false });
							
							// åˆä½µå„²å­˜æ ¼
							ws['!merges'] = [
								{ s: { r: 0, c: 0 }, e: { r: 0, c: 4 } },
								{ s: { r: 1, c: 0 }, e: { r: 1, c: 4 } },
								{ s: { r: 2, c: 0 }, e: { r: 2, c: 4 } }
							];
							
							// è¨­å®šæ¬„å¯¬
							ws['!cols'] = [{ wch: 15 }, { wch: 15 }, { wch: 40 }, { wch: 15 }, { wch: 20 }];
							
							// è¨­å®šæ¨™é ­å°é½Šæ–¹å¼ (å±…ä¸­/é å·¦)
							if(ws['A1']) ws['A1'].s = { alignment: { horizontal: "center", vertical: "center" } };
							if(ws['A2']) ws['A2'].s = { alignment: { horizontal: "left", vertical: "center" } };
							if(ws['A3']) ws['A3'].s = { alignment: { horizontal: "left", vertical: "center" } };

							XLSX.utils.book_append_sheet(wb, ws, "æ¸…å–®");
							const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
							zip.file(`è‡ªå‹•æŠ„è¡¨ä¾‹å¤–æ¸…å–®_${yyyymmdd}_${section}.xlsx`, wbout);
						}
					});

					const zipBlob = await zip.generateAsync({ type: "blob" });
					const zipUrl = URL.createObjectURL(zipBlob);

					statusDiv.textContent = `è™•ç†å®Œæˆï¼å…±ç”¢ç”Ÿ ${processedData.length} ç­†å»é‡å¾Œçš„è³‡æ–™ã€‚`;
					downloadArea.innerHTML = `
						<a href="${csvUrl}" download="exception.csv" class="download-link-box">ä¸‹è¼‰åˆä½µå¾Œçš„ exception.csv</a>
						<a href="${zipUrl}" download="reports.zip" class="download-link-box">ä¸‹è¼‰æ‹†åˆ†çš„ä¾‹å¤–æ¸…å–® (${sections.length} å€è™•)</a>
					`;
					downloadArea.style.display = 'flex';

				} catch (err) {
					statusDiv.textContent = `è™•ç†å¤±æ•—: ${err.message}`;
					console.error(err);
				}
			});
		})();
    </script>
</body>
</html>

